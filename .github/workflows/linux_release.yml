name: linux_release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v6
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          g++ \
          make \
          cmake \
          pkg-config \
          libunwind-dev \
          libfmt-dev \
          libspdlog-dev \
          libconfig-dev \
          libgstreamer1.0-dev \
          libgstrtspserver-1.0-dev

    - name: Build Linux amd64 binary
      run: |
        mkdir -p build
        cd build
        cmake ..
        make
        mkdir -p ../binaries
        cp rtsp-test-server ../binaries/

    - run: cd binaries && sha256sum -b * > checksums.sha256

    - uses: actions/upload-artifact@v6
      with:
        name: binaries
        path: binaries

  gcs_upload:
    needs: build
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/download-artifact@v7
      with:
        name: binaries
        path: binaries

    - uses: google-github-actions/auth@v3
      with:
        credentials_json: ${{ secrets.GCS_SA_KEY }}

    - name: Upload versioned release to GCS
      uses: google-github-actions/upload-cloud-storage@v3
      with:
        path: binaries
        destination: rtspstream/rtsp-test-server/releases/${{ inputs.version }}
        parent: false

    - name: Upload latest release to GCS
      uses: google-github-actions/upload-cloud-storage@v3
      with:
        path: binaries
        destination: rtspstream/rtsp-test-server/releases/latest
        parent: false
